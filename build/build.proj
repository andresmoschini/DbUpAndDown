<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="lib\MSBuild.Community.Tasks.Targets" />
  <Import Project="lib\MSBuild.Deployment.Tasks.Targets" />
  
  <PropertyGroup>
    <Root>$(MSBuildStartupDirectory)</Root>
    <nunitconsoleexe>$(Root)\lib\NUnit.Runners.2.6.2\tools\nunit-console.exe</nunitconsoleexe>
    <build_number Condition="'$(build_number)' == ''">0.0.0</build_number>
  </PropertyGroup>

  <Target Name="Build">
    <!-- Diagnostics -->
    <Message Text="Diagnostics:"/>
    <Message Text="Build Number:    $(build_number)" />
    <Message Text="Build dir:       $(MSBuildProjectDirectory)" />
    <Message Text="Project root:    $(Root)" />
    <Message Text="NUnit Console:   $(nunitconsoleexe)" />

    <!-- Clean up -->
    <ItemGroup>
      <FilesToDelete Include="$(Root)\src\**\bin\**\*.*" />
      <FilesToDelete Include="$(Root)\src\**\obj\**\*.*" />
      <FilesToDelete Include="$(Root)\build\Published\**\*.*" />
      <FilesToDelete Include="$(Root)\build\Artifacts\**\*.*" />
    </ItemGroup>
    <Delete Files="@(FilesToDelete)" ContinueOnError="true" />

    <!-- Ensure directories exists -->
    <MakeDir Directories="$(MSBuildProjectDirectory)\Artifacts" Condition="!Exists('$(MSBuildProjectDirectory)\Artifacts')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published" Condition="!Exists('$(MSBuildProjectDirectory)\Published')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown\Published')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown\lib" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown\Published\lib')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown\lib\NET35" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown\Published\lib\NET35')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown-SqlCe" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown-SqlCe\Published')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown-SqlCe\lib" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown-SqlCe\Published\lib')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown-SqlCe\lib\NET35" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown-SqlCe\Published\lib\NET35')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown-SQLite" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown-SQLite\Published')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown-SQLite\lib" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown-SQLite\Published\lib')" />
    <MakeDir Directories="$(MSBuildProjectDirectory)\Published\DbUpAndDown-SQLite\lib\NET35" Condition="!Exists('$(MSBuildProjectDirectory)\DbUpAndDown-SQLite\Published\lib\NET35')" />

    <!-- Version Info -->
    <AssemblyInfo
      CodeLanguage="CS"
      OutputFile="$(Root)\src\Information\VersionInfo.cs"
      AssemblyVersion="$(build_number).*"
      AssemblyFileVersion="$(build_number).0"
      />

    <!-- Zip source -->
    <ItemGroup>
      <SourceFilesToZip Include="$(Root)\src\**\*.*" />
      <SourceFilesToZip Include="$(Root)\lib\**\*.dll" Exclude="$(Root)\lib\NUnit.*\**\*.*" />
      <SourceFilesToZip Include="$(Root)\lib\**\*.dll" Exclude="$(Root)\lib\NSubstitute.*\**\*.*" />
    </ItemGroup>

    <Zip Files="@(SourceFilesToZip)"
      WorkingDirectory="$(Root)"
      ZipFileName="$(MSBuildProjectDirectory)\Artifacts\DbUpAndDown-$(build_number)-source.zip"
      ZipLevel="9"
      />
    
    <!-- Compile -->
    <ItemGroup>
      <ProjectToBuild Include="$(Root)\src\DbUpAndDown.sln" />
    </ItemGroup>
    <MSBuild Projects="@(ProjectToBuild)" Targets="Build" Properties="Configuration=Release;Platform=Any CPU">
      <Output TaskParameter="TargetOutputs" ItemName="AssembliesBuiltByChildProjects" />
    </MSBuild>

     <!-- Test --> 
    <ItemGroup>
        <TestAssembly Include="$(Root)\src\DbUpAndDown.Tests\bin\Release\DbUpAndDown.Tests.dll" />
    </ItemGroup>

    <Exec Condition="$(teamcity_dotnet_nunitlauncher) != ''" Command="&quot;$(teamcity_dotnet_nunitlauncher)&quot; v4.0 x86 NUnit-2.6.2 @(TestAssembly->'&quot;%(FullPath)&quot;', '%20')" />
    <Exec Condition="$(teamcity_dotnet_nunitlauncher) == ''" Command="&quot;$(nunitconsoleexe)&quot; @(TestAssembly->'&quot;%(FullPath)&quot;', '%20')" />

    <!-- Copy binaries -->
    <ItemGroup>
      <Net35Files Include="$(Root)\src\DbUpAndDown\bin\*.dll" />
      <Net35Files Include="$(Root)\src\DbUpAndDown\bin\*.xml" />
      <Net35Files Include="$(Root)\src\DbUpAndDown\bin\*.exe" />
      <Net35SqlCeFiles Include="$(Root)\src\DbUpAndDown.SqlCe\bin\Release\DbUpAndDown.SqlCe.dll" />
      <Net35SqlCeFiles Include="$(Root)\src\DbUpAndDown.SqlCe\bin\Release\DbUpAndDown.SqlCe.xml" />
    </ItemGroup>
    <Copy SourceFiles="@(Net35Files)" DestinationFolder="$(Root)\build\Published\DbUpAndDown\lib\NET35" />
    <Copy SourceFiles="@(Net35SqlCeFiles)" DestinationFolder="$(Root)\build\Published\DbUpAndDown-SqlCe\lib\NET35" />
    
    <!-- Zip binaries -->
    <ItemGroup>
      <BinaryFilesToZip Include="$(Root)\build\Published\DbUpAndDown\**\*.*" />
    </ItemGroup>
    <Zip Files="@(BinaryFilesToZip)"
      WorkingDirectory="$(Root)\build\Published\DbUpAndDown"
      ZipFileName="$(MSBuildProjectDirectory)\Artifacts\DbUpAndDown-$(build_number).zip"
      ZipLevel="9"
      />
    
    <!-- Add NuGet files-->    
    <ItemGroup>
      <NuSpecFiles Include="$(Root)\build\dbupanddown.nuspec" />
      <SqlCeNuSpecFiles Include="$(Root)\build\dbupanddown.sqlce.nuspec" />
      <SQLiteNuSpecFiles Include="$(Root)\build\dbupanddown.sqlite.nuspec" />
    </ItemGroup>
    <Copy SourceFiles="@(NuSpecFiles)" DestinationFolder="$(Root)\build\Published\DbUpAndDown" />
    <Copy SourceFiles="@(SqlCeNuSpecFiles)" DestinationFolder="$(Root)\build\Published\DbUpAndDown-SqlCe" />
    <Copy SourceFiles="@(SQLiteNuSpecFiles)" DestinationFolder="$(Root)\build\Published\DbUpAndDown-SQLite" />
    
    <PropertyGroup>
      <NuGetVersionNumber Condition="'$(NuGetVersionNumber)'==''">$(build_number)</NuGetVersionNumber>
    </PropertyGroup>

    <FileUpdate Files="$(Root)\build\Published\DbUpAndDown\dbupanddown.nuspec" Regex="0.0.0" ReplacementText="$(NuGetVersionNumber)" />
    <FileUpdate Files="$(Root)\build\Published\DbUpAndDown-SqlCe\dbupanddown.sqlce.nuspec" Regex="0.0.0" ReplacementText="$(NuGetVersionNumber)" />
    <FileUpdate Files="$(Root)\build\Published\DbUpAndDown-SQLite\dbupanddown.sqlite.nuspec" Regex="0.0.0" ReplacementText="$(NuGetVersionNumber)" />
    
    <!-- Pack -->
    <Exec Command="$(Root)\lib\nuget\nuget.exe pack $(Root)\build\Published\DbUpAndDown\dbupanddown.nuspec -BasePath $(Root)\build\Published\DbUpAndDown -o $(Root)\build\Artifacts" />
    <Exec Command="$(Root)\lib\nuget\nuget.exe pack $(Root)\build\Published\DbUpAndDown-SqlCe\dbupanddown.sqlce.nuspec -BasePath $(Root)\build\Published\DbUpAndDown-SqlCe -o $(Root)\build\Artifacts" />
    <Exec Command="$(Root)\lib\nuget\nuget.exe pack $(Root)\build\Published\DbUpAndDown-SQLite\dbupanddown.sqlite.nuspec -BasePath $(Root)\build\Published\DbUpAndDown-SQLite -o $(Root)\build\Artifacts" />
   
  </Target>
</Project>
